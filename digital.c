#include <stdbool.h>

// bool digits[10][14][7] = {
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 1, 1, 0, 0, 0},
//         {0, 1, 0, 1, 0, 0, 0},
//         {1, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 1, 0},
//         {0, 0, 0, 0, 0, 1, 0},
//         {0, 0, 0, 0, 1, 0, 0},
//         {0, 0, 0, 0, 1, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 0, 1, 0, 0, 0},
//         {0, 0, 1, 0, 0, 0, 0},
//         {0, 0, 1, 0, 0, 0, 0},
//         {0, 1, 0, 0, 0, 0, 0},
//         {0, 1, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//         {1, 0, 0, 0, 0, 0, 0},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//     },
//     {
//         {1, 1, 1, 1, 1, 1, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {0, 0, 0, 0, 0, 0, 1},
//         {1, 1, 1, 1, 1, 1, 1},
//     }
// };

// bool colon[14][2] = {
//     {0, 0},
//     {0, 0},
//     {0, 0},
//     {0, 0},
//     {1, 1},
//     {1, 1},
//     {0, 0},
//     {0, 0},
//     {1, 1},
//     {1, 1},
//     {0, 0},
//     {0, 0},
//     {0, 0},
//     {0, 0},
// };
//int hash = 60;

bool digits[10][5][3] = {
    {
        {1, 1, 1},
        {1, 0, 1},
        {1, 0, 1},
        {1, 0, 1},
        {1, 1, 1},
    },
    {
        {0, 0, 1},
        {0, 1, 1},
        {1, 0, 1},
        {0, 0, 1},
        {0, 0, 1},
    },
    {
        {1, 1, 1},
        {0, 0, 1},
        {1, 1, 1},
        {1, 0, 0},
        {1, 1, 1},
    },
    {
        {1, 1, 1},
        {0, 0, 1},
        {1, 1, 1},
        {0, 0, 1},
        {1, 1, 1},
    },
    {
        {1, 0, 1},
        {1, 0, 1},
        {1, 1, 1},
        {0, 0, 1},
        {0, 0, 1},
    },
    {
        {1, 1, 1},
        {1, 0, 0},
        {1, 1, 1},
        {0, 0, 1},
        {1, 1, 1},
    },
    {
        {1, 1, 1},
        {1, 0, 0},
        {1, 1, 1},
        {1, 0, 1},
        {1, 1, 1},
    },
    {
        {1, 1, 1},
        {0, 0, 1},
        {0, 1, 0},
        {0, 1, 0},
        {0, 1, 0},
    },
    {
        {1, 1, 1},
        {1, 0, 1},
        {1, 1, 1},
        {1, 0, 1},
        {1, 1, 1},
    },
    {
        {1, 1, 1},
        {1, 0, 1},
        {1, 1, 1},
        {0, 0, 1},
        {1, 1, 1},
    }
};

bool colon[5][2] = {
    {0, 0},
    {1, 1},
    {0, 0},
    {1, 1},
    {0, 0},
};

bool ledStates[60][16];

void reinitArrayBool2() {
    volatile int i = 0;
    volatile int li = sizeof(ledStates[0])/sizeof(ledStates[0][0]);
    while(i < li) {
        volatile int j = 0;
        volatile int lj = sizeof(ledStates)/sizeof(ledStates[0][0]);
        while(j < lj) {
            ledStates[i][j] = 0;
            j++;
        }
        i++;
    }
}

int digitToLedStates(int digit, int a) {
    volatile int i = 0;
    //volatile int li = sizeof(digits[digit][0])/sizeof(digits[digit][0][0]);
    //printf("li : %d", li);
    volatile int li = 3;
    volatile int j = 5;
    //volatile int lj = sizeof(digits[digit])/sizeof(digits[digit][0][0]);
    //printf("lj : %d", lj);
    //volatile int lj = 14;
    while(i < li) {
        j = 5;
        while(j >= 0) {
            ledStates[a+i][5-j+5] = digits[digit][j][i];
            j--;
        }
        i++;
    }

    return a+i+1;
}

int colonToLedStates(int a) {
    volatile int i = 0;
    volatile int li = 2;
    volatile int j = 0;
    volatile int lj = 5;
    while(i < li) {
        j = 0;
        while(j < lj) {
            ledStates[a+i][j+5] = colon[j][i];
            j++;
        }
        i++;
    }

    return a+i+1;
}



void hourToCurveLed() {
    //Prepare data
    reinitArrayBool2();

    int h1 = hour/10;
    int h2 = hour - h1*10;
    int m1 = minute/10;
    int m2 = minute - m1*10;

    int i = 13;

    i = digitToLedStates(h1, i);
    i = digitToLedStates(h2, i);
    i = colonToLedStates(i);
    i = digitToLedStates(m1, i);
    i = digitToLedStates(m2, i);
}

volatile int lastHour = 0;
volatile int lastMinute = 0;

volatile char char1 = 0x0000;
volatile char char2 = 0x0000;

void displayCurveTime() {
    if(lastMinute != minute || lastHour != hour) {
        hourToCurveLed();
        lastHour = hour;
        lastMinute = minute;
    }

    if(TCNT3 >= (turnTime/60)*(tour+1)) {
        tour += 1;

        char1 = 0x0000;
        char2 = 0x0000;

        volatile int j = 0;
        while(j < 16) {
            if(j < 8 && ledStates[tour][j])
                char1 |= 1 << (j%8);
            else if(j >= 8 && ledStates[tour][j])
                char2 |= 1 << (j%8);
            j++;
        }
    }
    
    SPI_MasterTransmit(char2, char1);
}
